<!DOCTYPE html>
<html lang="tr">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Mini Chat – {{ room_name }}</title>
        <style>
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
                    sans-serif;
                margin: 24px;
                background: #f8f9fa;
            }
            .wrap {
                max-width: 720px;
                margin: 0 auto;
            }
            h1 {
                margin: 0 0 8px;
            }
            #status {
                font-size: 14px;
                color: #666;
                margin-bottom: 16px;
            }
            #messages {
                height: 420px;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 12px;
                overflow-y: auto;
                background: #fff;
                margin-bottom: 12px;
            }
            .msg {
                margin: 6px 0;
                padding: 8px 10px;
                background: #f1f3f5;
                border-radius: 8px;
                border: 1px solid #eee;
                max-width: 80%;
                word-wrap: break-word;
            }
            .msg.me {
                background: #e7f1ff;
                border-color: #cfe2ff;
                margin-left: auto;
                text-align: right;
            }
            .username {
                font-size: 12px;
                color: #777;
                display: block;
                margin-bottom: 2px;
            }
            form {
                display: flex;
                gap: 8px;
            }
            input[type="text"] {
                flex: 1;
                padding: 10px 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            button {
                padding: 10px 14px;
                border: 0;
                border-radius: 8px;
                background: #1f7aec;
                color: #fff;
                cursor: pointer;
            }
            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <h1>Oda: {{ room_name }}</h1>
            <div id="status">Bağlantı kuruluyor…</div>

            <!-- Geçmiş mesajlar -->
            <div id="messages" aria-live="polite" aria-relevant="additions">
                {% for msg in messages %}
                <div
                    class="msg{% if msg.username == request.user.username %} me{% endif %}"
                >
                    <span class="username">{{ msg.username }}</span>
                    {{ msg.content }}
                </div>
                {% endfor %}
            </div>

            <!-- Mesaj gönderme formu -->
            <form id="chat-form" autocomplete="off">
                <input
                    id="message-input"
                    type="text"
                    placeholder="Mesaj yazın ve Enter’a basın…"
                />
                <button id="send-btn" type="submit">Gönder</button>
            </form>
        </div>

        <script>
            const roomName = "{{ room_name|escapejs }}";
            const wsScheme = location.protocol === "https:" ? "wss" : "ws";
            const wsUrl = `${wsScheme}://${location.host}/ws/chat/${roomName}/`;

            const statusEl = document.getElementById("status");
            const messagesEl = document.getElementById("messages");
            const formEl = document.getElementById("chat-form");
            const inputEl = document.getElementById("message-input");
            const sendBtn = document.getElementById("send-btn");

            function appendMessage(username, text, isMe = false) {
                const div = document.createElement("div");
                div.className = "msg" + (isMe ? " me" : "");
                div.innerHTML = `<span class="username">${username}</span>${text}`;
                messagesEl.appendChild(div);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            function setStatus(text) {
                statusEl.textContent = text;
            }

            let socket;
            connect();

            function connect() {
                socket = new WebSocket(wsUrl);

                socket.addEventListener("open", () => {
                    setStatus("Bağlantı kuruldu ✔︎");
                    sendBtn.disabled = false;
                });

                socket.addEventListener("message", (event) => {
                    const data = JSON.parse(event.data);
                    const username = data.username || "Anonim";
                    const text = data.message || "";
                    const isMe =
                        username === "{{ request.user.username|escapejs }}";
                    appendMessage(username, text, isMe);
                });

                socket.addEventListener("close", () => {
                    setStatus(
                        "Bağlantı kapandı. 3 sn içinde yeniden denenecek…"
                    );
                    sendBtn.disabled = true;
                    setTimeout(connect, 3000);
                });

                socket.addEventListener("error", () => {
                    setStatus("Hata oluştu. Yeniden bağlanmayı deniyorum…");
                });
            }

            formEl.addEventListener("submit", (e) => {
                e.preventDefault();
                const msg = inputEl.value.trim();
                if (!msg || socket.readyState !== WebSocket.OPEN) return;
                socket.send(JSON.stringify({ message: msg }));
                inputEl.value = "";
                inputEl.focus();
            });
        </script>
    </body>
</html>
